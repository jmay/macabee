#!/usr/bin/env ruby

require "macabee"
require "json"

arg = ARGV.first

if arg.nil?
  # dump entire AB
  ab = Macabee::Contacts.new
  puts JSON.pretty_generate(ab.to_hash)

elsif File.exists?(arg)
  # look in file for a JSON representation and compare it to version in the AB
  filename = arg
  hash = JSON.parse(File.read(filename))
  abid = hash['xref']['ab']
  ab = Macabee::Contacts.new
  contact = ab.fetch(abid)
  diffs = contact.compare(hash)
  if diffs.any?
    puts JSON.pretty_generate(diffs)
    contact.patch(diffs)
  else
    puts "No changes to apply"
  end

else
  # just pull this id from the AB and dump it out
  abid = arg

  ab = Macabee::Contacts.new
  rec = ab.fetch(abid) # could be Person or Group
  if rec
    puts JSON.pretty_generate(rec.to_hash)
    # puts rec.to_hash.dup.to_json
  else
    $stderr.puts "No such record #{abid}"
  end
end


# possible alternative usage:
#
# macabee dump
# macabee groups # list all group names & IDs
# macabee contact XXX # XXX could be internal ID or a string that should match exactly one record
# macabee group XXX
# macabee update file
