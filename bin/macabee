#!/usr/bin/env ruby

require 'macabee'
require 'thor'

$contacts = Macabee::Contacts.new

class MacabeeCommand < Thor
  desc "contacts", "dump all Address Book contacts to a single JSON blob"
  def contacts
    jj $contacts.contacts.map(&:to_hash)
  end

  desc "groups", "dump all Address Book groups to a single JSON blob"
  def groups
    jj $contacts.groups.map(&:to_hash)
  end

  desc "dump", "dump entire Address Book (contacts and groups) to a single JSON blob"
  def dump
    jj $contacts.to_hash
  end

  desc "show CONTACT", "dump a single Address Book contact (by UID or name) to JSON"
  def show(*args)
    if args.count > 1
      contact = $contacts.lookup(*args)
    else
      contact = $contacts.contact(args.first)
    end

    if !contact
      raise "No such person in Address Book '#{args}'"
    end
    jj contact.to_hash
  end

  desc "group GROUP", "dump a single Address Book group (by UID or name) to JSON, with just the UID values of the members"
  def group(arg)
    group = $contacts.group(arg)
    if !group
      group = $contacts.group_lookup(arg)
    end
    if !group
      raise "No such group in Address Book '#{arg}'"
    end
    jj group.to_hash
  end

  desc "members GROUP", "dump the members of a single Address Book group (by UID or name) to JSON"
  def members(arg)
    group = $contacts.group(arg)
    if !group
      group = $contacts.group_lookup(arg)
    end
    if !group
      raise "No such group in Address Book '#{arg}'"
    end
    jj group.members.map(&:to_hash)
  end

  desc "revisions JSONFILE", "compute deltas required to revise the inbound JSON to be in sync with the local Address Book"
  method_option :entire, :type => :boolean, :desc => "compare the entire Address Book, output record adds & deletes"
  def revisions(jsonfile)
    input = JSON.load(File.open(jsonfile))
    revisions = $contacts.revise(input, :additions => options[:entire])
    jj revisions
  end

  desc "compare JSONFILE", "compute deltas required to alter the local Address Book to match the data in the input JSON"
  def compare(jsonfile)
    input = JSON.load(File.open(jsonfile))
    input = [input] if input.is_a?(Hash) # for a single-record compare

    diffs = input.map do |contact_hash|
      $ab.diff(contact_hash)
    end.compact
    if diffs.any?
      jj diffs
      $stderr.puts "Found changes in #{diffs.count} out of #{input.count} records."
    else
      $stderr.puts "No changes in #{input.count} records."
    end
  end

  desc "apply JSONFILE", "update local Address Book by applying deltas computed from the `compare` step"
  method_option :dryrun, :type => :boolean, :desc => "stage the changes but do not save to the AB database"
  def apply(jsonfile)
    changes = JSON.load(File.open(jsonfile))
    additions = []
    changes.each do |uid, rule|
      # each record is a pair [id, instructions]
      # if id is not-nil, then instructions are an array of diffs
      # if id is nil, then instructions are a hash that represents an entire new record
      contact = uid ? $ab.contact(uid) : $ab.blank_contact
      additions << contact if !uid

      contact.apply(rule)
    end

    $stderr.puts "Applying #{additions.count} new contacts, #{changes.count - additions.count} updates."
    if options[:dryrun]
      $stderr.puts "(changes not applied to Address Book)"
    else
      ab.save!(additions)
    end
  end

end

MacabeeCommand.start
