#!/usr/bin/env ruby

require "macabee"
require "json"

arg = ARGV.first

if File.exists?(arg)
  # look in file for a JSON representation and compare it to version in the AB
  filename = arg
  hash = JSON.parse(File.read(filename))
  abid = hash['xref']['ab']
  ab = Macabee::Contacts.new
  contact = ab.fetch(abid)
  diffs = contact.compare(hash)
  if diffs.any?
    puts JSON.pretty_generate(diffs)
    contact.patch(diffs)
  else
    puts "No changes to apply"
  end
else
  # just pull this id from the AB and dump it out
  abid = arg

  ab = Macabee::Contacts.new
  contact = ab.fetch(abid)
  if contact
    puts JSON.pretty_generate(contact.to_hash)
  else
    $stderr.puts "No such contact #{abid}"
  end
end
